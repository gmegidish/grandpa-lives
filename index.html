<!doctype>
<html>
	<head>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
		<link rel="stylesheet" href="css/spritesheet.css">
	</head>
	<body style="margin: 0px;">
		<div id="canvas" style="width: 760px; height: 475px; position: relative; overflow: hidden;"></div>

		<script type="text/javascript">

		window.requestAnimFrame = (function(){
			return window.requestAnimationFrame || 
				window.webkitRequestAnimationFrame || 
				window.mozRequestAnimationFrame || 
				window.oRequestAnimationFrame || 
				window.msRequestAnimationFrame || 
				function(callback, element) {
					window.setTimeout(callback, 1000/60);
				};
			}
		)();

		var ZombieNode = function() {
			var d = document.createElement("div");
			d.setAttribute("class", "sprite sprite-zombie_left_0-png");
			d.style.position = "absolute";
			d.style.top = Math.random() * 475;
			d.style.left = Math.random() * 760;
			d.style.zIndex = parseInt(d.style.top) + 67;

			this.randomizeDest = function() {
				this.speedX = (3 + Math.random()*4) * 0.125;
				this.speedY = (3 + Math.random()*4) * 0.125;
	
				this.destX = Math.random() * 760;
				this.destY = Math.random() * 475;

				this.dir = (this.destX >= this.x) ? "right" : "left";
			}

			this.div = d;

			this.x = parseFloat(d.style.left);
			this.y = parseFloat(d.style.top);

			this.frame = Math.random() * 12;	
			this.mode = 0;

			this.randomizeDest();
		}

		var GirlNode = function() {
			var d = document.createElement("div");

			d.setAttribute("class", "sprite sprite-player_left_0-png");
			d.style.position = "absolute";
			d.style.top = 300;
			d.style.left = 400;
			d.style.zIndex = parseInt(d.style.top) + 42;

			this.div = d;
			this.x = parseFloat(d.style.left);
			this.y = parseFloat(d.style.top);
			this.frame = 0;
			this.direction = 0;
		}

		var GrandpaGame = function() {

			this.KEY_LEFT = 1;
			this.KEY_RIGHT = 2;
			this.KEY_UP = 4;
			this.KEY_DOWN = 8;
			this.KEY_ACTION = 16

			this.ZOMBIE_COUNT = 200;
			this.ZOMBIE_SPR_HEIGHT = 67;

			this.GAME_STATE_MENU = 0;
			this.GAME_STATE_PLAYING = 1;
			this.GAME_STATE_HEARTATTACK = 2;
			this.GAME_STATE_HIT = 3;
			this.GAME_STATE_MISS = 4;

			this.ZOMBIE_MODE_NORMAL = 0;
			this.ZOMBIE_MODE_ATTACK = 1;
			this.ZOMBIE_MODE_HAPPY = 2;

			this.zombies = [];

			this.cheatMode = false;

			this.menuFields = {
				currentOption: 0,
				startTime: 0,
				waitingForKeyRelease: false
			};

			this.hitMissFields = {
				startTime: 0
			};

			this.heartattackFields = {
				start: 0
			};

			this.keys = 0;
			this.gameTime = 0;
			this.gameState = this.GAME_STATE_MENU;

			this.gameCanvas = document.getElementById("canvas");

			this.initialize = function() {
				document.addEventListener("keyup", $.proxy(this.onKeyUp, this), false);
				document.addEventListener("keydown", $.proxy(this.onKeyDown, this), false);

				this.initMenu();
			}

			this.initMenu = function() {
				this.gameState = this.GAME_STATE_MENU;

				this.menuFields.startTime = this.gameTime;
				this.menuFields.currentOption = 0;
				this.menuFields.waitingForKeyRelease = false;

				// delete all other elements
				this.gameCanvas.innerHTML = "";

				// add background graphics
				var t = document.createElement("div");
				t.style.width = "100%"
				t.style.height = "100%";
				t.style.position = "absolute";
				t.style.backgroundImage = "url(gfx/menu2.png)";
				t.style.top = 0;
				t.style.left = 0;
				t.style.zIndex = 0;
				this.gameCanvas.appendChild(t); 

				var c = document.createElement("div");
				c.setAttribute("class", "sprite cursor");
				c.style.backgroundImage = "url(gfx/cursor.png)";
				c.style.position = "absolute";
				c.style.top = 314;
				c.style.left = 126;
				c.style.width = 11;
				c.style.height = 16;
				c.style.zIndex = 1;
				this.gameCanvas.appendChild(c);

				var logo = $("<div></div>");
				logo.css("backgroundImage", "url(gfx/logo-300.png)");
				logo.css("position", "absolute");
				logo.css("width", 300);
				logo.css("height", 213);
				logo.css("top", 50);
				logo.css("left", 64);
				logo.css("zIndex", 1);
				$(this.gameCanvas).append(logo);				

				var start = $("<div></div>");
				start.css("backgroundImage", "url(gfx/start.png)");
				start.css("position", "absolute");
				start.css("width", 160);
				start.css("height", 14);
				start.css("top", 316);
				start.css("left", 152);
				start.css("zIndex", 1);
				start.css("cursor", "pointer");
				$(this.gameCanvas).append(start);				

				var cheat = $("<div></div>");
				cheat.css("backgroundImage", "url(gfx/cheat.png)");
				cheat.css("position", "absolute");
				cheat.css("width", 76);
				cheat.css("height", 14);
				cheat.css("top", 349);
				cheat.css("left", 152);
				cheat.css("zIndex", 1);
				cheat.css("cursor", "pointer");
				$(this.gameCanvas).append(cheat);

				var right = document.createElement("div");
				right.setAttribute("class", "sprite sprite-menu-right-zombie");
				right.style.backgroundImage = "url(gfx/menu-right-zombie.png)";
				right.style.position = "absolute";
				right.style.width = 380;
				right.style.height = 475;
				right.style.top = 0;
				right.style.left = 760;
				right.style.zIndex = 1;
				this.gameCanvas.appendChild(right);				

				$(right).animate({
					left: 760-380
				}, 200);

				var that = this;
				$(start).click(function() {
					that.cheatMode = false;
					that.initGame();
				});

				$(cheat).click(function() {
					that.cheatMode = true;
					that.initGame();
				});
			}

			this.initGame = function() {

				this.gameState = this.GAME_STATE_PLAYING;
				this.gameCanvas.innerHTML = "";

				// create 300 zombies
				for (var i=0; i<this.ZOMBIE_COUNT; i++) {
					var zombie = new ZombieNode();
					this.zombies.push(zombie);
					this.gameCanvas.appendChild(zombie.div);
				}

				// create little girl
				this.girl = new GirlNode();
				this.gameCanvas.appendChild(this.girl.div);

				// create background texture
				var t = document.createElement("div");
				t.style.width = "100%"
				t.style.height = "100%";
				t.style.position = "absolute";
				t.style.backgroundImage = "url(gfx/texture-bg.png)";
				t.style.top = 0;
				t.style.left = 0;
				t.style.zIndex = 0;
				this.gameCanvas.appendChild(t);
			}

			this.processInput = function() {

				var frameChanged = false;

				if (this.keys & this.KEY_LEFT) {
					if (this.girl.x > 0) {
						this.girl.x -= 3;
						this.girl.div.style.left = this.girl.x;
						this.girl.direction = "left";

						frameChanged = true;
					}
				} else if (this.keys & this.KEY_RIGHT) {
					if (this.girl.x < 760) {
						this.girl.x += 3;
						this.girl.div.style.left = this.girl.x;
						this.girl.direction = "right";
						frameChanged = true;
					}
				}

				if (this.keys & this.KEY_UP) {
					if (this.girl.y > 0) {
						this.girl.y -= 3;
						this.girl.div.style.top = this.girl.y;
						this.girl.div.style.zIndex = this.girl.y + 42;
		
						frameChanged = true;
					}
				} else if (this.keys & this.KEY_DOWN) {
					if (this.girl.y < 475) {
						this.girl.y += 3;
						this.girl.div.style.top = this.girl.y;
						this.girl.div.style.zIndex = this.girl.y + 42;
						frameChanged = true;
					}
				}

				if (frameChanged) {
					this.girl.frame++;
					this.girl.frame %= 3;
					this.girl.div.setAttribute("class", "sprite sprite-player_" + this.girl.direction + "_" + this.girl.frame + "-png");
				}

				if (this.keys & this.KEY_ACTION) {
					this.initHeartattack();
				}
			}
			
			this.initHeartattack = function() {
				this.gameState = this.GAME_STATE_HEARTATTACK;
				this.heartattackFields.start = +new Date();
			}

			this.initHit = function() {

				this.gameState = this.GAME_STATE_HIT;
				this.hitMissFields.startTime = this.gameTime;

				// process grandpa
				this.zombies[0].destX = parseInt(this.gameCanvas.style.width);
				this.zombies[0].destY = this.zombies[0].y;
				this.zombies[0].speedX = 1.5;
				this.zombies[0].speedY = 0.0;
				this.zombies[0].mode = this.ZOMBIE_MODE_HAPPY;

				for (var i=1; i<this.zombies.length; i++) {
					this.zombies[i].frame = Math.floor(Math.random() * 12);
					this.zombies[i].speedX = 0.15;
					this.zombies[i].speedY = 0.15;
				}

				// init flashing banner
				var div = document.createElement("div");
				div.setAttribute("class", "sprite sprite-lives-png");
				div.style.position = "absolute";
				div.style.top = (parseInt(this.gameCanvas.style.height) - 28 - 20);
				div.style.left = (parseInt(this.gameCanvas.style.width) - 422)/2;
				div.style.zIndex = 50000;
				this.gameCanvas.appendChild(div);

				this.flashingText = div;
			}

			this.initMiss = function() {
				this.gameState = this.GAME_STATE_MISS;
				this.hitMissFields.startTime = this.gameTime;
	
	                        var MASS_MURDER_RADIUS = 120;
				var TIME_TILL_MASS_MURDER = 250/15;

				// Mix_PlayChannel(-1, missSfx, 0);
				for (var i=1; i<this.zombies.length; i++) {
					var t = 2*Math.PI*Math.random();
					var u = Math.random() + Math.random();
					var r = (u > 1) ? (2-u) : u;
			
					var x = MASS_MURDER_RADIUS*r*Math.cos(t);
					var y = MASS_MURDER_RADIUS*r*Math.sin(t);
			
					this.zombies[i].destX = this.girl.x + x;
					this.zombies[i].destY = this.girl.y + y;
					this.zombies[i].speedX = Math.abs(this.zombies[i].destX - this.zombies[i].x)/TIME_TILL_MASS_MURDER;
					this.zombies[i].speedY = Math.abs(this.zombies[i].destY - this.zombies[i].y)/TIME_TILL_MASS_MURDER;
					this.zombies[i].frame = Math.floor(Math.random() * 12);
					this.zombies[i].mode = this.ZOMBIE_MODE_ATTACK;
				}

				// process grandpa
				if (Math.abs(this.girl.y - this.zombies[0].y) > MASS_MURDER_RADIUS) {
					// far away from crowd
					this.zombies[0].destY = this.zombies[0].y;
					if (this.zombies[0].x < (760/2)) {
						this.zombies[0].destX = 760;
					} else {
						this.zombies[0].destX = -70;
					}
				} else {
					// too close to crowd
					this.zombies[0].destX = this.zombies[0].x;
					if (this.zombies[0].y < (475/2)) {
						this.zombies[0].destY = 475;
					} else {
						this.zombies[0].destY = -70;
					}
				}

				this.zombies[0].speedX = 1.5;
				this.zombies[0].speedY = 1.5;
				this.zombies[0].mode = this.ZOMBIE_MODE_HAPPY;

				// init flashing banner
				var div = document.createElement("div");
				div.setAttribute("class", "sprite sprite-leaves-png");
				div.style.position = "absolute";
				div.style.top = (parseInt(this.gameCanvas.style.height) - 28 - 20);
				div.style.left = (parseInt(this.gameCanvas.style.width) - 462)/2;
				div.style.zIndex = 50000;
				this.gameCanvas.appendChild(div);

				this.flashingText = div;
			}

			this.heartattackTick = function() {
				var diff = this.gameTime - this.heartattackFields.start;
				if (diff > 2000) {
					this.initHit();
				}
			}

			this.onKeyDown = function(e) {
				switch(e.keyCode) {
					case 32:
					this.keys |= this.KEY_ACTION;
					e.preventDefault();
					break;

					case 37:
					this.keys |= this.KEY_LEFT;
					e.preventDefault();
					break;

					case 38:
					this.keys |= this.KEY_UP;
					e.preventDefault();
					break;

					case 39:
					this.keys |= this.KEY_RIGHT;
					e.preventDefault();
					break;

					case 40:
					this.keys |= this.KEY_DOWN;
					e.preventDefault();
					break;
				}

			}

			this.onKeyUp = function(e) {
				switch(e.keyCode) {
					case 32:
					this.keys &= ~this.KEY_ACTION;
					e.preventDefault();
					break;

					case 37:
					this.keys &= ~this.KEY_LEFT;
					e.preventDefault();
					break;

					case 38:
					this.keys &= ~this.KEY_UP;
					e.preventDefault();
					break;

					case 39:
					this.keys &= ~this.KEY_RIGHT;
					e.preventDefault();
					break;

					case 40:
					this.keys &= ~this.KEY_DOWN;
					e.preventDefault();
					break;
				}
			}

			this.singleZombieStep = function() {
				for (var i=0; i<this.zombies.length; i++) {

					var x = this.zombies[i].x;
					var y = this.zombies[i].y;
					var dx = this.zombies[i].destX;
					var dy = this.zombies[i].destY;
					var sx = this.zombies[i].speedX;
					var sy = this.zombies[i].speedY;

					var dir = this.zombies[i].dir;

					if (x < dx) {
						// going right
						dir = "right";
						x = Math.min(x+sx, dx);
					} else if (x > dx) {
						dir = "left";
						x = Math.max(x-sx, dx);	
					}

					if (y < dy) {
						// going down
						y = Math.min(y+sy, dy);
					} else if (y > dy) {
						y = Math.max(y-sy, dy);
					}

					this.zombies[i].x = x;
					this.zombies[i].y = y;
					this.zombies[i].dir = dir;
					this.zombies[i].div.style.top = y;
					this.zombies[i].div.style.left = x;
					this.zombies[i].div.style.zIndex = parseInt(this.zombies[i].y) + this.ZOMBIE_SPR_HEIGHT;

					this.zombies[i].frame++;
					this.zombies[i].frame %= 24;

					var f = [0,1,0,2][Math.floor(this.zombies[i].frame/6)];
					var mode;
					switch(this.zombies[i].mode) {
						case this.ZOMBIE_MODE_NORMAL:
						mode = "zombie";
						break;
					
						case this.ZOMBIE_MODE_ATTACK:
						mode = "attack";
						break;
					
						case this.ZOMBIE_MODE_HAPPY:
						mode = "happy";
						break;
					}
					
					this.zombies[i].div.setAttribute("class", "sprite sprite-" + mode + "_" + dir + "_" + f + "-png");

					if (x == dx && y == dy) {
						if (this.gameState == this.GAME_STATE_PLAYING) {
							this.zombies[i].randomizeDest();
						}
					}
				}

				if (this.cheatMode) {

					var o = (Math.floor(this.gameTime/150))%2;
					this.zombies[0].div.style.opacity = o;
				}

				if (this.gameState == this.GAME_STATE_HIT || this.gameState == this.GAME_STATE_MISS) {
					var diff = this.gameTime - this.hitMissFields.startTime;
					var flipflop = Math.floor(diff/250) % 2;
					this.flashingText.style.opacity = (1 - flipflop);

					this.girl.x += 1.5;
					this.girl.div.style.left = this.girl.x;
					this.girl.direction = "right";
					this.girl.frame++;
					this.girl.frame %= 3;
					this.girl.div.setAttribute("class", "sprite sprite-player_" + this.girl.direction + "_" + this.girl.frame + "-png");
				}
			}

			this.menuGameTick = function() {

				if (this.menuFields.waitingForKeyRelease == false) {
					if (this.keys & (this.KEY_UP | this.KEY_DOWN)) {
						this.menuFields.waitingForKeyRelease = true;
						this.menuFields.currentOption ^= 1;

						var c = $(".cursor");
						var y = 314 + ((this.menuFields.currentOption == 0) ? 0 : 33);
						c.css("top", y);
					}

					if (this.keys & this.KEY_ACTION) {
						this.keys = 0;
						this.cheatMode = (this.menuFields.currentOption == 1);
						this.initGame();
					}
				} else {
					if ((this.keys & (this.KEY_UP | this.KEY_DOWN)) == 0) {
						this.menuFields.waitingForKeyRelease = false;
					}
				}
			}

			this.gamePlayTick = function() {
				this.processInput();
				this.singleZombieStep();
			}		

			this.hitOrMissTick = function() {
				this.singleZombieStep();

				if (this.keys & this.KEY_ACTION) {
					// only after 3 seconds
					var diff = this.gameTime - this.hitMissFields.startTime;
					if (diff >= 3000) {
						this.keys = 0;
						this.initMenu();
					}		
				}
			}

			this.gameTick = function() {
				var that = this;
				window.requestAnimFrame(function() { that.gameTick() });

				this.gameTime = (+new Date());

				switch(this.gameState) {
					case this.GAME_STATE_PLAYING:
					this.gamePlayTick();
					break;

					case this.GAME_STATE_HIT:
					case this.GAME_STATE_MISS:
					this.hitOrMissTick();
					break;

					case this.GAME_STATE_HEARTATTACK:
					this.heartattackTick();
					break;

					case this.GAME_STATE_MENU:
					this.menuGameTick();
					break;
				}
			}

			this.run = function() {
				var that = this;
				window.requestAnimFrame(function() { that.gameTick() });
			}
		}

		var game;

		$(document).ready(function() { 
			game = new GrandpaGame();

			game.initialize(); 
			game.run();

			$("#canvas").focus();
		});
		</script>
	</body>
</html>